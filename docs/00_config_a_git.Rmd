---
title: "Configuration de Git + GitHub dans RStudio"
output:
  html_document:
    output_dir: "docs"
    self_contained: true
---

**Pr√©ambule.** Un projet informatique est compos√© de fichier(s) de codes. 

Les standards du travail collaboratif permettent √† plusieurs personnes d'intervenir sur les m√™mes fichiers. Pour cela on utilise un service nomm√© "Git".

En R sous Rstudio, on travaille dans un "projet" : ce "projet" Rstudio est associ√© √† un r√©pertoire, dans lequel il y a tous les fichiers de codes du projet. 

> Il est recommand√© d‚Äôutiliser syst√©matiquement les projets RStudio. https://book.utilitr.org/03_Fiches_thematiques/Fiche_rprojects.html 

Une notion importante va √™tre √©claircie dans la suite du document :

> Il est recommand√© de cr√©er un projet RStudio en clonant un d√©p√¥t distant *[un repo Github ou un projet Gitlab]*. https://book.utilitr.org/03_Fiches_thematiques/Fiche_git_utilisation.html

Dans ce document, on va voir comment configurer Git sous Rstudio pour avoir la possibilit√© de "cloner un d√©p√¥t distant".

Le lead-dev va te demander ton nom de profil github et te filer des acc√®s √† un projet : la balle est dans ton camp ensuite.

### I. Installer Git

[Si pas encore fait il faut installer Git, sinon passer √† l'√©tape suivante] 

- Installer le programme "Git" depuis https://git-scm.com
- Pendant l'installation, tu peux tout laisser par d√©faut et dire "oui √† tout"... mais faire des recherches autour des termes que tu ne comprends pas ds les nombreux menus qui s'affichent √† l'installation de Git ne serait pas du luxe.
- Si Rstudio √©tait ouvert : il faut red√©marrer Rstudio pour qu'il prenne en compte l'installation de Git.

**V√©rifier que Git est install√©.** En console Rstudio : 

     system("git --version")

Sinon : installer depuis https://git-scm.com

**V√©rifier si Git est bien reconnu dans les options globales de Rstudio.** Dans le menu Rstudio `Tools > Global Options > **Git/SVN**`

V√©rifier que "*Enable version control interface for RStudio projects*" est coch√© dans le menu global, et qu'il y a un chemin vers le git executable.

Sp√©cifier le chemin vers Git s‚Äôil n‚Äôest pas d√©tect√© (il faut pointer vers le "git.exe" sur Windows).

### Configurer Git globalement

**Associer un user et un mail par d√©faut.** En commandes terminal on peut configurer des options globales de git :

    git config --global user.name "Pr√©nom Nom"

    git config --global user.email "son@email.com"

L'historique des modifications {scrut√© par le lead-dev'} propose le user.name et aussi le user.email, pour suivre qui fait quoi sur le projet.

**Indiquer un token √† Git et Rstudio.** Il faut un token (code secret) pour que Rstudio soit capable d'*√©crire* dans les repos Github auxquels le user peut acc√©der. De m√™me pour *lire* les repo priv√©s. 

- Soit le token est stock√© dans le fichier .Renviron 

- Soit via le *Git credential store* (gitcreds)

Donc on veux un token global, pour acc√©der √† tous les repos auxquels l'utilisateur √† acc√®s sur Github.

#### II. Creer token 

1. Aller^[Ou alors via les menus : sous la photo de profil cliquer sur "settings" => et ensuite en bas du menu "Developer Settings" => "Personal access tokens"] sur : https://github.com/settings/tokens 

2. G√©n√©rer un token simple 'personal access token', a minima avec les `scopes` (port√©es) repo (le token permet d'acc√©der aux repos du user) et workflow (si on utilise GitHub Actions).

3. Copier le token dans un fichier. 

#### III. Reporter le token pour Rstudio
Il y a deux m√©thodes pour stocker le token du user et pouvoir √©crire sur github et donc mettre √† jour son travail au fur-et-√†-mesure.

**M√©thode 1.** On peut stocker le token au niveau du fichier .Renviron global (g√©n√©ralement au niveau de "Mes documents" sous Windows avec l'installation R et Rstudio par d√©faut). 

Pour ouvrir ce fichier :

     usethis::edit_r_environ() 

Et j'y fait une entr√©e avec le token comme ci-ensuite :

`GITHUB_PAT=ghp_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX`

On peut red√©marrer Rstudio et passer aux √©tapes de cr√©ation d'un projet.

**MAIS.** Cette m√©thode peut emp√™cher l'acc√®s par d√©faut de Rstudio au Git credential store, cens√© reposer sur le magasin de certificats du OS.

Par exemple, `usethis::git_sitrep()` renvoie un warning expliquant que cette 1√®re m√©thode pourrait interf√©rer avec la 2nde, i.e. '`can prevent your PAT from being retrieved from the Git credential store`'.

     usethis::git_sitrep()


    [...]
    ! C:/Users/CLEM/Documents/.Renviron defines the environment variable: GITHUB_PAT
    ! This can prevent your PAT from being retrieved from the Git credential store.
    ‚Ñπ For most use cases, it is better to NOT define the PAT in .Renviron.
    ‚òê Call usethis::edit_r_environ() to edit that file.
    ‚òê Then call gitcreds::gitcreds_set() to put the PAT into the Git credential store.

**M√©thode 2.** Comme le sugg√®re usethis::git_sitrep(), on peut aussi stocker de facon plus s√©curis√©e le token avec :

    # install.packages("gitcreds")
    gitcreds::gitcreds_set()

- S'il y a d√©j√† un token report√© dans le .Renviron, il faut **supprimer** la ligne du .Renviron avec le token (`usethis::edit_r_environ()` pour ouvrir ce fichier .Renviron).

> S'il y a d√©j√† un "password" (qui correspond en r√©alit√© √† un token) `gitcreds::gitcreds_set()` va proposer de les remplacer par d'autres valeurs => option n¬∞ 2. 

> Et tu peux copier-coller le token dans la console donc quand on te le demande, sans guillemets.

√Ä partir de l√† tu aura acc√®s √† certaines commandes :

    usethis::git_push()

Ou encore pour voir le token :

    gitcreds::gitcreds_get()

Et configurer un token ou github

    usethis::create_github_token()
    usethis::use_github()    
    
## Configurer un projet

### Cloner ou cr√©er un projet Git
Il faut toujours cr√©er un repo github ou qu'il y en ai un. Selon si le projet existe d√©j√† localement ou non :

- Soit on cl√¥ne un repo GitHub existant, pour cr√©er un nouveau projet Rstudio (New Project > Version Control > Git). Il ne faut *pas* cr√©er le projet dans une nouvelle session si Rstudio perd l'acc√®s √† internet en red√©marrant (p. ex. si l'acc√®s internet n√©cessite de r√©gler un proxy d'entreprise).

- Soit on configure un projet existant, si le projet Rstudio est d√©j√† cr√©√© localement (Project Options > Git => et on indique l'adresse du projet au niveau de 'Origin').

#### Projet d√©j√† cr√©√© locament + repo Github d√©j√† existant
(p. ex. si le projet est sur un disque partag√©)

Selon la config' associ√©e, il faut ouvrir le projet et faire :
(Project Options > Git => et on indique l'adresse du projet au niveau de 'Origin')

Ou bien lancer un peu de code R ou terminal pour faire la m√™me chose.

#### Commencer un nouveau projet √† partir de rien
En g√©n√©ral, **si le projet est nouveau** :

1. On veut commencer par cr√©er un repo sur Github pour l'associer √† un projet Rstudio

2. Et reporter dans Rstudio l'adresse https du projet - ou l'adresse 'SSH' si ssh est configur√© (sur le github du projet il y a un gros bouton vert `<> Code` qui d√©roule l'adresse HTTPS et SSH ; et 

1. on commence par cr√©er un repo sur Github. On laisse tout vide g√©n√©ralement.
2. on va r√©cup√©rer l'adresse (gros bouton vert `<> Code` propose l'adresse HTTPS et SSH). L'adresse HTTPS est aussi d√©ductible comme 'nom-du-user/repo'.
3. on veut indiquer cette adresse au niveau du projet sous Rstudio, via les menus Rstudio :

> "Nouveau projet" ==> "Version control" ==> "Git"

{et on reporte l'adresse https}

#### Synchroniser un projet d√©j√† cr√©√© localement
Si le projet est d√©j√† cr√©√© sur l'ordinateur mais que le repo github est vide, il faut initialiser l'archive git locale avec ce qu'on a et push cette premi√®re contribution via :

- des commandes terminal, 
- l'interface 'git' de Rstudio
- ou encore avec des fonctions de `usethis::`

Ci-ensuite l'une des possibilit√©s pour initialiser le projet.

**En commandes terminal.** Depuis le projet Rstudio, le terminal aura d√©j√† plac√© le curseur au niveau du r√©pertoire du projet. Tu peux donc simplement:


    git init
    git remote add origin https://github.com/ton-utilisateur/ton-repo.git
    git add .
    git commit -m "üöÄ Initial commit depuis projet local"
    git branch -M main
    git push -u origin main
    
Ici c'est une adresse https au niveau de la commande `add origin`, mais √ßa peut √™tre une cl√©e ssh.


---

Dans RStudio, on devrait donc pouvoir acc√©der √† une interface de "contr√¥le des versions" fonctionnelle => fen√™tre de "commit changes" dans laquelle on peut choisir des fichiers, fl√®ches pour "push" vers Github.

### Commandes terminal pour bosser avec github

- git status         # voir les changements
- git add .          # ajouter tous les fichiers modifi√©s
- git commit -m "Message clair"   # cr√©er un commit
- git push           # envoyer au repo GitHub
- git pull           # r√©cup√©rer les changements du repo

### Git tricks and treats
Parfois l'archive .git plante d√®s les premi√®res √©tapes de "add" des fichiers dans l'archive. 

Il faut supprimer le fichier index.lock avec une commande terminal.
 
    rm -f .git/index.lock

E.g., de message d'erreur qui n√©cessite de supprimer ce fichier.

    git add .
    fatal: Unable to create 'C:/Users/CLEM/Documents/PROJETS_EN_R/financr/.git/index.lock': File exists.

     Another git process seems to be running in this repository, e.g.
     an editor opened by 'git commit'. Please make sure all processes
     are terminated then try again. If it still fails, a git process
     may have crashed in this repository earlier:
     remove the file manually to continue.

    CLEM@DELL MINGW64 ~/Documents/PROJETS_EN_R/financr (main)
    rm -f .git/index.lock

> [et on recommence :
git add .
git commit -m "Initial commit"
etc.
]

### Restaurer un fichier
Parfois on introduit un bogue sans s'en rendre compte, et on r√©alise plein d'autres modifications ensuite.
On veut donc g√©n√©ralement (a) copier le fichier trafiqu√© et (b) re-importer le fichier dans une version pr√©alable aux modif'.

M√©thode 1. On peut voir directement sur github.com le fichier 'raw', remonter l'historique avec 'history' [et choisir un commit ou un autre] et copier √† la mano...

M√©thode 2. On peut voir l'historique des commits dans un fichier pr√©cis avec une commande terminal :

`git log -- <chemin_relatif/du/fichier>`

p.ex. `git log -- 3_annule_remplace/corrections_anomalies_de_stock.R`

D√®s qu'on identifie le bon commit on peut restaurer le fichier dans une version identique √† ce qu'il √©tait au moment de ce commit

`git checkout abc1234_numero_du_commit -- chemin_relatif/du/fichier`

Et donc √ßa restaure le fichier [d'o√π la n√©cessit√© de le copier d'abord avec un nouveau nom] et on peut ensuite commit √† nouveau
`git add chemin/du/fichier`
`git commit -m "Restauration de l'√©tat de [fichier] avant bugs`

### Github action
Le token doit souvent √™tre pass√© directement au niveau d'une action Github. 

Ajouter le token comme secret dans ton d√©p√¥t.

> Aller sur le d√©p√¥t ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret

Choisir un nom et coller le token.
