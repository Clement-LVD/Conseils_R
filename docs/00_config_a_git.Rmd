---
title: "Configuration de Git + GitHub dans RStudio"
output:
  html_document:
    output_dir: "docs"
    self_contained: true
---

**PrÃ©ambule.** Un projet informatique est composÃ© de fichier(s) de codes. 

Les standards du travail collaboratif permettent Ã  plusieurs personnes d'intervenir sur les mÃªmes fichiers. Pour cela on utilise un service nommÃ© "Git".

En R sous Rstudio, on travaille dans un "projet" : ce "projet" Rstudio est associÃ© Ã  un rÃ©pertoire, dans lequel il y a tous les fichiers de codes du projet. 

> Il est recommandÃ© dâ€™utiliser systÃ©matiquement les projets RStudio. https://book.utilitr.org/03_Fiches_thematiques/Fiche_rprojects.html 

Une notion importante va Ãªtre Ã©claircie dans la suite du document :

> Il est recommandÃ© de crÃ©er un projet RStudio en clonant un dÃ©pÃ´t distant *[un repo Github ou un projet Gitlab]*. https://book.utilitr.org/03_Fiches_thematiques/Fiche_git_utilisation.html

Dans ce document, on va voir comment configurer Git sous Rstudio pour avoir la possibilitÃ© de "cloner un dÃ©pÃ´t distant".

Le lead-dev va te demander ton nom de profil github et te filer des accÃ¨s Ã  un projet : la balle est dans ton camp ensuite.

### I. Installer Git

[Si pas encore fait il faut installer Git, sinon passer Ã  l'Ã©tape suivante] 

- Installer le programme "Git" depuis https://git-scm.com
- Pendant l'installation, tu peux tout laisser par dÃ©faut et dire "oui Ã  tout"... mais faire des recherches autour des termes que tu ne comprends pas ds les nombreux menus qui s'affichent Ã  l'installation de Git ne serait pas du luxe.
- Si Rstudio Ã©tait ouvert : il faut redÃ©marrer Rstudio pour qu'il prenne en compte l'installation de Git.

**VÃ©rifier que Git est installÃ©.** En console Rstudio : 

     system("git --version")

Sinon : installer depuis https://git-scm.com

**VÃ©rifier si Git est bien reconnu dans les options globales de Rstudio.** Dans le menu Rstudio `Tools > Global Options > **Git/SVN**`

VÃ©rifier que "*Enable version control interface for RStudio projects*" est cochÃ© dans le menu global, et qu'il y a un chemin vers le git executable.

SpÃ©cifier le chemin vers Git sâ€™il nâ€™est pas dÃ©tectÃ© (il faut pointer vers le "git.exe" sur Windows).

### Configurer Git globalement

**Associer un user et un mail par dÃ©faut.** En commandes terminal on peut configurer des options globales de git :

    git config --global user.name "PrÃ©nom Nom"

    git config --global user.email "son@email.com"

L'historique des modifications {scrutÃ© par le lead-dev'} propose le user.name et aussi le user.email, pour suivre qui fait quoi sur le projet.

**Indiquer un token Ã  Git et Rstudio.** Il faut un token (code secret) pour que Rstudio soit capable d'*Ã©crire* dans les repos Github auxquels le user peut accÃ©der. De mÃªme pour *lire* les repo privÃ©s. 

- Soit le token est stockÃ© dans le fichier .Renviron 

- Soit via le *Git credential store* (gitcreds)

Donc on veux un token global, pour accÃ©der Ã  tous les repos auxquels l'utilisateur Ã  accÃ¨s sur Github.

#### II. Creer token 

1. Aller^[Ou alors via les menus : sous la photo de profil cliquer sur "settings" => et ensuite en bas du menu "Developer Settings" => "Personal access tokens"] sur : https://github.com/settings/tokens 

2. GÃ©nÃ©rer un token simple 'personal access token', a minima avec les `scopes` (portÃ©es) repo (le token permet d'accÃ©der aux repos du user) et workflow (si on utilise GitHub Actions).

3. Copier le token dans un fichier. 

#### III. Reporter le token pour Rstudio
Il y a deux mÃ©thodes pour stocker le token du user et pouvoir Ã©crire sur github et donc mettre Ã  jour son travail au fur-et-Ã -mesure.

**MÃ©thode 1.** On peut stocker le token au niveau du fichier .Renviron global (gÃ©nÃ©ralement au niveau de "Mes documents" sous Windows avec l'installation R et Rstudio par dÃ©faut). 

Pour ouvrir ce fichier :

     usethis::edit_r_environ() 

Et j'y fait une entrÃ©e avec le token comme ci-ensuite :

`GITHUB_PAT=ghp_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX`

On peut redÃ©marrer Rstudio et passer aux Ã©tapes de crÃ©ation d'un projet.

**MAIS.** Cette mÃ©thode peut empÃªcher l'accÃ¨s par dÃ©faut de Rstudio au Git credential store, censÃ© reposer sur le magasin de certificats du OS.

Par exemple, `usethis::git_sitrep()` renvoie un warning expliquant que cette 1Ã¨re mÃ©thode pourrait interfÃ©rer avec la 2nde, i.e. '`can prevent your PAT from being retrieved from the Git credential store`'.

     usethis::git_sitrep()


    [...]
    ! C:/Users/CLEM/Documents/.Renviron defines the environment variable: GITHUB_PAT
    ! This can prevent your PAT from being retrieved from the Git credential store.
    â„¹ For most use cases, it is better to NOT define the PAT in .Renviron.
    â˜ Call usethis::edit_r_environ() to edit that file.
    â˜ Then call gitcreds::gitcreds_set() to put the PAT into the Git credential store.

**MÃ©thode 2.** Comme le suggÃ¨re usethis::git_sitrep(), on peut aussi stocker de facon plus sÃ©curisÃ©e le token avec :

    # install.packages("gitcreds")
    gitcreds::gitcreds_set()

- S'il y a dÃ©jÃ  un token reportÃ© dans le .Renviron, il faut **supprimer** la ligne du .Renviron avec le token (`usethis::edit_r_environ()` pour ouvrir ce fichier .Renviron).

> S'il y a dÃ©jÃ  un "password" (qui correspond en rÃ©alitÃ© Ã  un token) `gitcreds::gitcreds_set()` va proposer de les remplacer par d'autres valeurs => option nÂ° 2. 

> Et tu peux copier-coller le token dans la console donc quand on te le demande, sans guillemets.

Ã€ partir de lÃ  tu aura accÃ¨s Ã  certaines commandes :

    usethis::git_push()

Ou encore pour voir le token :

    gitcreds::gitcreds_get()

Et configurer un token ou github

    usethis::create_github_token()
    usethis::use_github()    
    
## Configurer un projet

### Cloner ou crÃ©er un projet Git
Il faut toujours crÃ©er un repo github ou qu'il y en ai un. Selon si le projet existe dÃ©jÃ  localement ou non :

- Soit on clÃ´ne un repo GitHub existant, pour crÃ©er un nouveau projet Rstudio (New Project > Version Control > Git). Il ne faut *pas* crÃ©er le projet dans une nouvelle session si Rstudio perd l'accÃ¨s Ã  internet en redÃ©marrant (p. ex. si l'accÃ¨s internet nÃ©cessite de rÃ©gler un proxy d'entreprise).

- Soit on configure un projet existant, si le projet Rstudio est dÃ©jÃ  crÃ©Ã© localement (Project Options > Git => et on indique l'adresse du projet au niveau de 'Origin').

#### Projet dÃ©jÃ  crÃ©Ã© locament + repo Github dÃ©jÃ  existant
(p. ex. si le projet est sur un disque partagÃ©)

Selon la config' associÃ©e, il faut ouvrir le projet et faire :
(Project Options > Git => et on indique l'adresse du projet au niveau de 'Origin')

Ou bien lancer un peu de code R ou terminal pour faire la mÃªme chose.

#### Commencer un nouveau projet Ã  partir de rien
En gÃ©nÃ©ral, **si le projet est nouveau** :

1. On veut commencer par crÃ©er un repo sur Github pour l'associer Ã  un projet Rstudio

2. Et reporter dans Rstudio l'adresse https du projet - ou l'adresse 'SSH' si ssh est configurÃ© (sur le github du projet il y a un gros bouton vert `<> Code` qui dÃ©roule l'adresse HTTPS et SSH ; et 

1. on commence par crÃ©er un repo sur Github. On laisse tout vide gÃ©nÃ©ralement.
2. on va rÃ©cupÃ©rer l'adresse (gros bouton vert `<> Code` propose l'adresse HTTPS et SSH). L'adresse HTTPS est aussi dÃ©ductible comme 'nom-du-user/repo'.
3. on veut indiquer cette adresse au niveau du projet sous Rstudio, via les menus Rstudio :

> "Nouveau projet" ==> "Version control" ==> "Git"

{et on reporte l'adresse https}

#### Synchroniser un projet dÃ©jÃ  crÃ©Ã© localement
Si le projet est dÃ©jÃ  crÃ©Ã© sur l'ordinateur mais que le repo github est vide, il faut initialiser l'archive git locale avec ce qu'on a et push cette premiÃ¨re contribution via :

- des commandes terminal, 
- l'interface 'git' de Rstudio
- ou encore avec des fonctions de `usethis::`

Ci-ensuite l'une des possibilitÃ©s pour initialiser le projet.

**En commandes terminal.** Depuis le projet Rstudio, le terminal aura dÃ©jÃ  placÃ© le curseur au niveau du rÃ©pertoire du projet. Tu peux donc simplement:


    git init
    git remote add origin https://github.com/ton-utilisateur/ton-repo.git
    git add .
    git commit -m "ğŸš€ Initial commit depuis projet local"
    git branch -M main
    git push -u origin main
    
Ici c'est une adresse https au niveau de la commande `add origin`, mais Ã§a peut Ãªtre une clÃ©e ssh.


---

Dans RStudio, on devrait donc pouvoir accÃ©der Ã  une interface de "contrÃ´le des versions" fonctionnelle => fenÃªtre de "commit changes" dans laquelle on peut choisir des fichiers, flÃ¨ches pour "push" vers Github.

### Commandes terminal pour bosser avec github

- git status         # voir les changements
- git add .          # ajouter tous les fichiers modifiÃ©s
- git commit -m "Message clair"   # crÃ©er un commit
- git push           # envoyer au repo GitHub
- git pull           # rÃ©cupÃ©rer les changements du repo

### Git tricks and treats
Parfois l'archive .git plante dÃ¨s les premiÃ¨res Ã©tapes de "add" des fichiers dans l'archive. 

Il faut supprimer le fichier index.lock avec une commande terminal.
 
    rm -f .git/index.lock

E.g., de message d'erreur qui nÃ©cessite de supprimer ce fichier.

    git add .
    fatal: Unable to create 'C:/Users/CLEM/Documents/PROJETS_EN_R/financr/.git/index.lock': File exists.

     Another git process seems to be running in this repository, e.g.
     an editor opened by 'git commit'. Please make sure all processes
     are terminated then try again. If it still fails, a git process
     may have crashed in this repository earlier:
     remove the file manually to continue.

    CLEM@DELL MINGW64 ~/Documents/PROJETS_EN_R/financr (main)
    rm -f .git/index.lock

> [et on recommence :
git add .
git commit -m "Initial commit"
etc.
]


### Github action
Le token doit souvent Ãªtre passÃ© directement au niveau d'une action Github. 

Ajouter le token comme secret dans ton dÃ©pÃ´t.

> Aller sur le dÃ©pÃ´t â†’ Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret

Choisir un nom et coller le token.