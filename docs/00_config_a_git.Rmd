---
title: "Configuration de Git + GitHub dans RStudio"
output:
  html_document:
    output_dir: "docs"
    self_contained: true
---

### I. Installer Git

[Si pas encore fait il faut installer Git, sinon passer Ã  l'Ã©tape suivante]

#### VÃ©rifier que Git est installÃ©
En console Rstudio : 

     system("git --version")
     
Ou en "Terminal" :

     git --version

Sinon : installer depuis https://git-scm.com

#### VÃ©rifier si Git est bien reconnu dans les options globales de Rstudio

> Menu : Tools > Global Options > **Git/SVN**

VÃ©rifier que "Enable version control interface for RStudio projects" est cochÃ© dans le menu global.

SpÃ©cifier le chemin vers Git sâ€™il nâ€™est pas dÃ©tectÃ© (git.exe sur Windows par exemple)

#### Associer un user et un mail par dÃ©faut
En commandes terminal :

    git config --global user.name "PrÃ©nom Nom"

    git config --global user.email "son@email.com"

### Configurer l'accÃ¨s de Rstudio

Ã€ noter : sois on indique un accÃ¨s https (comme on va le voir ci-ensuite) soit un lien ssh, si on a configurÃ© une clÃ©e SSH. 

**Pour synchroniser un repo github et un projet Rstudio avec un lien http.** Il faut un token (code secret) pour que Rstudio soit capable d'Ã©crire dans les repos Github auxquels le user peut accÃ©der. 

- Soit le token est stockÃ© dans le fichier .Renviron 

- Soit via le *Git credential store* (gitcreds)

Donc on va configurer ci-ensuite un token global d'accÃ¨s aux repos.

#### II. Creer token 

1. Aller^[Ou alors via les menus : sous la photo de profil cliquer sur "settings" => et ensuite en bas du menu "Developer Settings" => "Personal access tokens"] sur : https://github.com/settings/tokens 

2. GÃ©nÃ©rer un token simple 'personal access token', a minima avec les `scopes` (portÃ©es) repo (le token permet d'accÃ©der aux repos du user) et workflow (si on utilise GitHub Actions).

3. Copier le token dans un fichier. 

- (On peut aussi gÃ©nÃ©rer un "Fine grained token" mais il me faut creuser davantage ce qui change via ce menu)

#### III. Reporter le token pour Rstudio
Il y a deux mÃ©thodes pour stocker le token du user et pouvoir Ã©crire sur github et donc mettre Ã  jour son travail au fur-et-Ã -mesure.

**MÃ©thode 1.** On peut stocker le token au niveau du fichier .Renviron global (gÃ©nÃ©ralement au niveau de "Mes documents" sous Windows avec l'installation R et Rstudio par dÃ©faut). 

Pour ouvrir ce fichier :

     usethis::edit_r_environ() 

Et j'y fait une entrÃ©e avec le token comme ci-ensuite :

`GITHUB_PAT=ghp_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX`

On peut redÃ©marrer Rstudio et passer aux Ã©tapes de crÃ©ation d'un projet.

**MAIS.** Cette mÃ©thode peut empÃªcher l'accÃ¨s par dÃ©faut de Rstudio au Git credential store, censÃ© reposer sur le magasin de certificats du OS.

Par exemple, `usethis::git_sitrep()` renvoie un warning expliquant que cette 1Ã¨re mÃ©thode pourrait interfÃ©rer avec la 2nde, i.e. '`can prevent your PAT from being retrieved from the Git credential store`'.

     usethis::git_sitrep()


    [...]
    ! C:/Users/CLEM/Documents/.Renviron defines the environment variable: GITHUB_PAT
    ! This can prevent your PAT from being retrieved from the Git credential store.
    â„¹ If you are troubleshooting PAT problems, the root cause may be an old, invalid PAT defined in C:/Users/CLEM/Documents/.Renviron.
    â„¹ For most use cases, it is better to NOT define the PAT in .Renviron.
    â˜ Call usethis::edit_r_environ() to edit that file.
    â˜ Then call gitcreds::gitcreds_set() to put the PAT into the Git credential store.

**MÃ©thode 2.** Comme le suggÃ¨re usethis::git_sitrep(), on peut aussi stocker de facon plus sÃ©curisÃ©e le token avec :

    # install.packages("gitcreds")
    gitcreds::gitcreds_set()

- S'il y a dÃ©jÃ  un token reportÃ© dans le .Renviron, il faut **supprimer** la ligne du .Renviron avec le token (`usethis::edit_r_environ()` pour ouvrir ce fichier .Renviron).

> S'il y a dÃ©jÃ  un "password" (qui correspond en rÃ©alitÃ© Ã  un token) `gitcreds::gitcreds_set()` va proposer de les remplacer par d'autres valeurs => option nÂ° 2. 

> Et tu peux copier-coller le token dans la console donc quand on te le demande, sans guillemets.

Ã€ partir de lÃ  tu aura accÃ¨s Ã  certaines commandes :

    usethis::git_push()

Ou encore pour voir le token :

    gitcreds::gitcreds_get()

Et configurer un token ou github

    usethis::create_github_token()
    usethis::use_github()    
    
## Configurer un projet

### Cloner ou crÃ©er un projet Git

- Soit on clÃ´ne un repo GitHub existant (New Project > Version Control > Git)

- Soit on configure Git sur un projet existant (Project Options > Git)

En gÃ©nÃ©ral :

1. On veut dans tous les cas crÃ©er un repo sur Github pour l'associer Ã  un projet Rstudio

2. Et reporter dans Rstudio l'adresse https - ou l'adresse 'SSH' si une clÃ©e ssh est configurÃ©e - du projet, visible sur Github ou dÃ©ductible en tant que 'nom-du-user/repo'.

#### Initialiser un nouveau projet
Le plus simple pour synchroniser un projet Rstudio et un repo github, c'est gÃ©nÃ©ralement d'indiquer l'adresse https (ou SSH) d'un nouveau repo vierge, Ã  la crÃ©ation d'un nouveau projet Rstudio.

Donc on commence par crÃ©er un repo sur Github.

> "Nouveau projet" ==> "Version control" ==> "Git"

**Il faut indiquer l'adresse SSH (!) dans la "Repository url" et Ã©ventuellement un nom de projet (nom du dossier que Rstudio va crÃ©er) s'il est diffÃ©rent**.

> Il faut suivre ce flux de travail pour "rÃ©cupÃ©rer" un projet pour la 1ere fois sur un nouveau poste, typiquement pour travailler sur plusieurs postes (au moment de la 1Ã¨re configuration du 2nd poste), s'insÃ©rer dans un travail collaboratif dÃ©jÃ  en cours (rÃ©cupÃ©rer le projet pour la 1Ã¨re fois), etc.

#### Synchroniser
Si le projet est dÃ©jÃ  crÃ©Ã© sur l'ordinateur mais que le repo github est vide, il faut initialiser l'archive avec :

- en commandes terminal, 
- via l'interface 'git' de Rstudio
- ou encore avec des fonctions de `usethis::`

Ci-ensuite l'une des possibilitÃ©s pour initialiser le projet.

**En commandes terminal.** Depuis le projet Rstudio, le terminal aura dÃ©jÃ  placÃ© le curseur au niveau du rÃ©pertoire du projet. Tu peux donc simplement:


    git init
    git remote add origin https://github.com/ton-utilisateur/ton-repo.git
    git add .
    git commit -m "ğŸš€ Initial commit depuis projet local"
    git branch -M main
    git push -u origin main
    
Ici c'est une adresse https au niveau de la commande `add origin`, mais Ã§a peut Ãªtre une clÃ©e ssh.


---

Dans RStudio, on devrait donc pouvoir accÃ©der Ã  une interface de "contrÃ´le des versions" fonctionnelle => fenÃªtre de "commit changes" dans laquelle on peut choisir des fichiers, flÃ¨ches pour "push" vers Github.

### Commandes terminal pour bosser avec github

- git status         # voir les changements
- git add .          # ajouter tous les fichiers modifiÃ©s
- git commit -m "Message clair"   # crÃ©er un commit
- git push           # envoyer au repo GitHub
- git pull           # rÃ©cupÃ©rer les changements du repo

### Git tricks and treats
Parfois l'archive .git plante dÃ¨s les premiÃ¨res Ã©tapes de "add" des fichiers dans l'archive. 

Il faut supprimer le fichier index.lock avec une commande terminal.
 
    rm -f .git/index.lock

E.g., de message d'erreur qui nÃ©cessite de supprimer ce fichier.

    git add .
    fatal: Unable to create 'C:/Users/CLEM/Documents/PROJETS_EN_R/financr/.git/index.lock': File exists.

     Another git process seems to be running in this repository, e.g.
     an editor opened by 'git commit'. Please make sure all processes
     are terminated then try again. If it still fails, a git process
     may have crashed in this repository earlier:
     remove the file manually to continue.

    CLEM@DELL MINGW64 ~/Documents/PROJETS_EN_R/financr (main)
    rm -f .git/index.lock

> [et on recommence :
git add .
git commit -m "Initial commit"
etc.
]


### Github action
Le token doit souvent Ãªtre passÃ© directement au niveau d'une action Github. 

Ajouter le token comme secret dans ton dÃ©pÃ´t.

> Aller sur le dÃ©pÃ´t â†’ Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret

Choisir un nom et coller le token.